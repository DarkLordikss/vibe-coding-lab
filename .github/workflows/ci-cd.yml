name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: hospital-management-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} -t ${{ env.DOCKER_IMAGE }}:latest .
    
    - name: Save Docker image
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > image.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: image.tar.gz
        retention-days: 1

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      env:
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        set -e
        python -m unittest test_main -v || {
          echo "‚ùå Unit tests failed!"
          exit 1
        }
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
        if-no-files-found: ignore

  load-tests:
    name: Load Testing with Locust
    runs-on: ubuntu-latest
    needs: [build, unit-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .
    
    - name: Load Docker image
      run: |
        gunzip -c image.tar.gz | docker load
    
    - name: Build test image
      run: |
        docker build -f Dockerfile.test -t ${{ env.DOCKER_IMAGE }}-test:${{ env.DOCKER_TAG }} .
    
    - name: Start Redis container
      run: |
        docker run -d --name redis-loadtest \
          -p 6379:6379 \
          --health-cmd="redis-cli ping" \
          --health-interval=5s \
          --health-timeout=3s \
          --health-retries=5 \
          redis:7-alpine
    
    - name: Wait for Redis to be ready
      run: |
        timeout 30 bash -c 'until docker exec redis-loadtest redis-cli ping; do sleep 1; done'
    
    - name: Start application container
      run: |
        docker run -d --name app-loadtest \
          --network host \
          -e REDIS_HOST=localhost \
          -e REDIS_PORT=6379 \
          -e TORNADO_AUTORELOAD=false \
          -e TORNADO_DEBUG=false \
          -p 8888:8888 \
          ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
    
    - name: Wait for application to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8888/; do sleep 1; done'
    
    - name: Run load tests
      run: |
        set -e
        docker run --rm \
          --network host \
          -e REDIS_HOST=localhost \
          -e REDIS_PORT=6379 \
          ${{ env.DOCKER_IMAGE }}-test:${{ env.DOCKER_TAG }} \
          locust -f load_test.py \
            --host=http://localhost:8888 \
            --users=10 \
            --spawn-rate=2 \
            --run-time=30s \
            --headless \
            --html=load_test_report.html \
            --csv=load_test_results || {
              echo "‚ùå Load tests failed!"
              exit 1
            }
    
    - name: Upload load test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: load-test-results
        path: |
          load_test_report.html
          load_test_results*.csv
        if-no-files-found: ignore
    
    - name: Cleanup
      if: always()
      run: |
        docker stop app-loadtest redis-loadtest || true
        docker rm app-loadtest redis-loadtest || true

  deploy:
    name: Deploy to VM (Mock)
    runs-on: ubuntu-latest
    needs: [build, unit-tests, load-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .
    
    - name: Load Docker image
      run: |
        gunzip -c image.tar.gz | docker load
    
    - name: Mock Deployment to VM
      env:
        SSH_HOST: ${{ secrets.SSH_HOST || 'deploy.example.com' }}
        SSH_USER: ${{ secrets.SSH_USER || 'deploy' }}
        SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        DOCKER_TAG: ${{ env.DOCKER_TAG }}
      run: |
        echo "=========================================="
        echo "üöÄ Starting deployment to VM..."
        echo "=========================================="
        echo ""
        echo "üìã Deployment Configuration:"
        echo "   VM Host: ${SSH_HOST}"
        echo "   SSH User: ${SSH_USER}"
        echo "   SSH Port: ${SSH_PORT}"
        echo "   Docker Image: ${{ env.DOCKER_IMAGE }}:${DOCKER_TAG}"
        echo ""
        
        echo "üíæ Step 1: Backing up current deployment..."
        echo "   ‚Üí Connecting to ${SSH_USER}@${SSH_HOST}:${SSH_PORT}"
        echo "   ‚Üí Checking for existing containers..."
        echo "   ‚Üí Saving current Docker image..."
        echo "   ‚úÖ Backup completed successfully"
        echo ""
        
        echo "üì¶ Step 2: Preparing deployment package..."
        echo "   ‚Üí Docker image size: $(docker images ${{ env.DOCKER_IMAGE }}:${DOCKER_TAG} --format '{{.Size}}')"
        echo "   ‚Üí Compressing image..."
        echo "   ‚úÖ Package prepared: deploy-image.tar.gz"
        echo ""
        
        echo "üì§ Step 3: Uploading files to VM..."
        echo "   ‚Üí Uploading deploy-image.tar.gz..."
        echo "   ‚Üí Uploading docker-compose.yml..."
        echo "   ‚Üí Uploading deployment scripts..."
        echo "   ‚úÖ Files uploaded successfully"
        echo ""
        
        echo "üîß Step 4: Setting up on VM..."
        echo "   ‚Üí Connecting via SSH..."
        echo "   ‚Üí Creating deployment directory: /tmp/deploy"
        echo "   ‚Üí Loading Docker image..."
        echo "   ‚Üí Stopping existing containers..."
        echo "   ‚Üí Starting new containers..."
        echo "   ‚úÖ Containers started"
        echo ""
        
        echo "‚è≥ Step 5: Waiting for services to be healthy..."
        echo "   ‚Üí Waiting for Redis to be ready..."
        echo "   ‚Üí Waiting for application to start..."
        sleep 3
        echo "   ‚úÖ All services are healthy"
        echo ""
        
        echo "üîç Step 6: Verifying deployment..."
        echo "   ‚Üí Checking containers status..."
        echo "      ‚úì Container 'hospital-app-redis' is running"
        echo "      ‚úì Container 'hospital-app' is running"
        echo "   ‚Üí Testing application endpoints..."
        echo "      ‚úì GET http://${SSH_HOST}:8888/ - OK (200)"
        echo "      ‚úì GET http://${SSH_HOST}:8888/analytics - OK (200)"
        echo "      ‚úì GET http://${SSH_HOST}:8888/stats - OK (200)"
        echo "   ‚úÖ All checks passed"
        echo ""
        
        echo "=========================================="
        echo "‚úÖ Deployment completed successfully!"
        echo "=========================================="
        echo ""
        echo "üìä Deployment Summary:"
        echo "   Status: SUCCESS"
        echo "   Version: ${DOCKER_TAG}"
        echo "   Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "   Application URL: http://${SSH_HOST}:8888"
        echo ""


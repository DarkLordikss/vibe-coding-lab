name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: hospital-management-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} -t ${{ env.DOCKER_IMAGE }}:latest .
    
    - name: Save Docker image
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > image.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: image.tar.gz
        retention-days: 1

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      env:
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        set -e
        python -m unittest test_main -v || {
          echo "âŒ Unit tests failed!"
          exit 1
        }
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
        if-no-files-found: ignore

  load-tests:
    name: Load Testing with Locust
    runs-on: ubuntu-latest
    needs: [build, unit-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .
    
    - name: Load Docker image
      run: |
        gunzip -c image.tar.gz | docker load
    
    - name: Build test image
      run: |
        docker build -f Dockerfile.test -t ${{ env.DOCKER_IMAGE }}-test:${{ env.DOCKER_TAG }} .
    
    - name: Start Redis container
      run: |
        docker run -d --name redis-loadtest \
          -p 6379:6379 \
          --health-cmd="redis-cli ping" \
          --health-interval=5s \
          --health-timeout=3s \
          --health-retries=5 \
          redis:7-alpine
    
    - name: Wait for Redis to be ready
      run: |
        timeout 30 bash -c 'until docker exec redis-loadtest redis-cli ping; do sleep 1; done'
    
    - name: Start application container
      run: |
        docker run -d --name app-loadtest \
          --network host \
          -e REDIS_HOST=localhost \
          -e REDIS_PORT=6379 \
          -e TORNADO_AUTORELOAD=false \
          -e TORNADO_DEBUG=false \
          -p 8888:8888 \
          ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
    
    - name: Wait for application to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8888/; do sleep 1; done'
    
    - name: Run load tests
      run: |
        set -e
        docker run --rm \
          --network host \
          -e REDIS_HOST=localhost \
          -e REDIS_PORT=6379 \
          ${{ env.DOCKER_IMAGE }}-test:${{ env.DOCKER_TAG }} \
          locust -f load_test.py \
            --host=http://localhost:8888 \
            --users=10 \
            --spawn-rate=2 \
            --run-time=30s \
            --headless \
            --html=load_test_report.html \
            --csv=load_test_results || {
              echo "âŒ Load tests failed!"
              exit 1
            }
    
    - name: Upload load test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: load-test-results
        path: |
          load_test_report.html
          load_test_results*.csv
        if-no-files-found: ignore
    
    - name: Cleanup
      if: always()
      run: |
        docker stop app-loadtest redis-loadtest || true
        docker rm app-loadtest redis-loadtest || true

  deploy:
    name: Deploy to VM (Mock)
    runs-on: ubuntu-latest
    needs: [build, unit-tests, load-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .
    
    - name: Load Docker image
      run: |
        gunzip -c image.tar.gz | docker load
    
    - name: Mock Deployment to VM
      env:
        SSH_HOST: ${{ secrets.SSH_HOST || 'deploy.example.com' }}
        SSH_USER: ${{ secrets.SSH_USER || 'deploy' }}
        SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        DOCKER_TAG: ${{ env.DOCKER_TAG }}
      run: |
        echo "=========================================="
        echo "ðŸš€ Starting deployment to VM..."
        echo "=========================================="
        echo ""
        echo "ðŸ“‹ Deployment Configuration:"
        echo "   VM Host: ${SSH_HOST}"
        echo "   SSH User: ${SSH_USER}"
        echo "   SSH Port: ${SSH_PORT}"
        echo "   Docker Image: ${{ env.DOCKER_IMAGE }}:${DOCKER_TAG}"
        echo ""
        
        echo "ðŸ’¾ Step 1: Backing up current deployment..."
        echo "   â†’ Connecting to ${SSH_USER}@${SSH_HOST}:${SSH_PORT}"
        echo "   â†’ Checking for existing containers..."
        echo "   â†’ Saving current Docker image..."
        echo "   âœ… Backup completed successfully"
        echo ""
        
        echo "ðŸ“¦ Step 2: Preparing deployment package..."
        echo "   â†’ Docker image size: $(docker images ${{ env.DOCKER_IMAGE }}:${DOCKER_TAG} --format '{{.Size}}')"
        echo "   â†’ Compressing image..."
        echo "   âœ… Package prepared: deploy-image.tar.gz"
        echo ""
        
        echo "ðŸ“¤ Step 3: Uploading files to VM..."
        echo "   â†’ Uploading deploy-image.tar.gz..."
        echo "   â†’ Uploading docker-compose.yml..."
        echo "   â†’ Uploading deployment scripts..."
        echo "   âœ… Files uploaded successfully"
        echo ""
        
        echo "ðŸ”§ Step 4: Setting up on VM..."
        echo "   â†’ Connecting via SSH..."
        echo "   â†’ Creating deployment directory: /tmp/deploy"
        echo "   â†’ Loading Docker image..."
        echo "   â†’ Stopping existing containers..."
        echo "   â†’ Starting new containers..."
        echo "   âœ… Containers started"
        echo ""
        
        echo "â³ Step 5: Waiting for services to be healthy..."
        echo "   â†’ Waiting for Redis to be ready..."
        echo "   â†’ Waiting for application to start..."
        sleep 3
        echo "   âœ… All services are healthy"
        echo ""
        
        echo "ðŸ” Step 6: Verifying deployment..."
        echo "   â†’ Checking containers status..."
        echo "      âœ“ Container 'hospital-app-redis' is running"
        echo "      âœ“ Container 'hospital-app' is running"
        echo "   â†’ Testing application endpoints..."
        echo "      âœ“ GET http://${SSH_HOST}:8888/ - OK (200)"
        echo "      âœ“ GET http://${SSH_HOST}:8888/analytics - OK (200)"
        echo "      âœ“ GET http://${SSH_HOST}:8888/stats - OK (200)"
        echo "   âœ… All checks passed"
        echo ""
        
        echo "=========================================="
        echo "âœ… Deployment completed successfully!"
        echo "=========================================="
        echo ""
        echo "ðŸ“Š Deployment Summary:"
        echo "   Status: SUCCESS"
        echo "   Version: ${DOCKER_TAG}"
        echo "   Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "   Application URL: http://${SSH_HOST}:8888"
        echo ""

  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [build, unit-tests, load-tests, deploy]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Print summary
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Load Tests | ${{ needs.load-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if pipeline failed
        if [ "${{ needs.unit-tests.result }}" != "success" ] || \
           [ "${{ needs.load-tests.result }}" != "success" ]; then
          echo "âŒ **Pipeline failed due to test failures**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" == "failure" ]; then
          echo "âš ï¸  **Deployment failed**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… **Pipeline completed successfully**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

